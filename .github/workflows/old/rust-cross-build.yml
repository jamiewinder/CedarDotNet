name: Build Rust Binaries for NuGet

on:
  workflow_dispatch:

jobs:
  build-rust:
    name: Build Rust (${{ matrix.target }}) on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        include:
          # Linux targets
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            nugetRid: linux-x64

          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            nugetRid: linux-arm64

          # Windows targets
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            nugetRid: win-x64

          - os: windows-latest
            target: aarch64-pc-windows-msvc
            nugetRid: win-arm64

          # macOS targets
          - os: macos-latest
            target: x86_64-apple-darwin
            nugetRid: osx-x64

          - os: macos-latest
            target: aarch64-apple-darwin
            nugetRid: osx-arm64

    steps:
      - name: 📥 Checkout source
        uses: actions/checkout@v4

      - name: 🦀 Add Rust target
        run: rustup target add ${{ matrix.target }}

      - name: 🛠️ Install linker (Linux only, for cross-compilation)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
          fi

      - name: 🧱 Build with Cargo
        working-directory: src/CedarDotNetFfi
        run: cargo build --release --target=${{ matrix.target }}

      - name: 📦 Organize binaries in NuGet-compatible layout
        shell: bash
        run: |
          mkdir -p runtimes/${{ matrix.nugetRid }}/native
          cp src/CedarDotNetFfi/target/${{ matrix.target }}/release/*.dll runtimes/${{ matrix.nugetRid }}/native 2>/dev/null || true
          cp src/CedarDotNetFfi/target/${{ matrix.target }}/release/*.so runtimes/${{ matrix.nugetRid }}/native 2>/dev/null || true
          cp src/CedarDotNetFfi/target/${{ matrix.target }}/release/*.dylib runtimes/${{ matrix.nugetRid }}/native 2>/dev/null || true

      - name: ⬆️ Upload runtime-specific artifact
        uses: actions/upload-artifact@v4
        with:
          name: runtimes-${{ matrix.nugetRid }}
          path: runtimes/${{ matrix.nugetRid }}/native/